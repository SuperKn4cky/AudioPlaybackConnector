name: Build Windows x64

on:
  push:
    tags: ["**"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: Checkout source
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git init .
          git config --global http.https://github.com/.extraheader "AUTHORIZATION: bearer $env:GITHUB_TOKEN"
          git remote add origin "git@github.com:SuperKn4cky/AudioPlaybackConnector.git"
          git fetch --depth 1 origin "${{ github.sha }}"
          git checkout --force FETCH_HEAD
          git submodule update --init --recursive --depth 1

      - name: Validate toolchain
        shell: pwsh
        run: |
          python --version
          nuget help | Select-Object -First 1
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          if (!(Test-Path $vswhere)) { throw "vswhere.exe not found" }

      - name: Generate resources
        shell: pwsh
        run: |
          cd translate
          python po2ymo.py ./source/zh_CN.po ./generated/zh_CN.ymo
          python po2ymo.py ./source/zh_TW.po ./generated/zh_TW.ymo
          @"
          #include "../../targetver.h"
          #include "windows.h"

          LANGUAGE LANG_CHINESE, SUBLANG_CHINESE_SIMPLIFIED
          1 YMO "zh_CN.ymo"

          LANGUAGE LANG_CHINESE, SUBLANG_CHINESE_TRADITIONAL
          1 YMO "zh_TW.ymo"
          "@ | Out-File -FilePath ./generated/translate.rc -Encoding utf8

      - name: Restore NuGet packages
        shell: pwsh
        run: nuget restore AudioPlaybackConnector.sln -NonInteractive

      - name: Locate MSBuild
        shell: pwsh
        run: |
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          $msbuildPath = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -find "MSBuild\**\Bin\MSBuild.exe" | Select-Object -First 1
          if (-not $msbuildPath) { throw "MSBuild.exe not found" }
          "MSBUILD_PATH=$msbuildPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build x64 Release
        shell: pwsh
        run: |
          & "$env:MSBUILD_PATH" AudioPlaybackConnector.sln `
            -p:Configuration=Release `
            -p:Platform=x64

      - name: Generate checksum
        shell: pwsh
        run: |
          Get-FileHash -Algorithm SHA256 x64/Release/AudioPlaybackConnector64.exe | `
            ForEach-Object { "$($_.Hash)  AudioPlaybackConnector64.exe" } | `
            Out-File -FilePath x64/Release/AudioPlaybackConnector64.exe.sha256 -Encoding ascii

      - name: Publish release
        if: github.ref_type == 'tag'
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $ErrorActionPreference = "Stop"
          $tag = "${{ github.ref_name }}"
          $repo = "${{ github.repository }}"
          $apiBase = "https://api.github.com/repos/$repo"

          $headers = @{
            Authorization = "Bearer $env:GITHUB_TOKEN"
            Accept = "application/vnd.github+json"
            "X-GitHub-Api-Version" = "2022-11-28"
            "User-Agent" = "AudioPlaybackConnector-CI"
          }

          $assetsToUpload = @(
            "x64/Release/AudioPlaybackConnector64.exe",
            "x64/Release/AudioPlaybackConnector64.exe.sha256"
          )
          foreach ($assetPath in $assetsToUpload) {
            if (!(Test-Path -Path $assetPath)) {
              throw "Missing release asset: $assetPath"
            }
          }

          $encodedTag = [System.Uri]::EscapeDataString($tag)
          $release = $null
          try {
            $release = Invoke-RestMethod `
              -Method Get `
              -Uri "$apiBase/releases/tags/$encodedTag" `
              -Headers $headers
          } catch {
            $statusCode = $null
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode) {
              $statusCode = [int]$_.Exception.Response.StatusCode
            }

            if ($statusCode -eq 404) {
              $body = @{
                tag_name = $tag
                name = $tag
                draft = $true
                prerelease = $false
              } | ConvertTo-Json -Depth 4

              $release = Invoke-RestMethod `
                -Method Post `
                -Uri "$apiBase/releases" `
                -Headers $headers `
                -Body $body `
                -ContentType "application/json"
            } else {
              throw
            }
          }

          if (-not $release) {
            throw "Unable to resolve or create release for tag $tag"
          }

          $existingAssets = @()
          if ($release.assets_url) {
            $existingAssets = Invoke-RestMethod `
              -Method Get `
              -Uri $release.assets_url `
              -Headers $headers
          }

          $uploadUrlBase = ($release.upload_url -replace '\{\?name,label\}$', '')
          if (-not $uploadUrlBase) {
            throw "Release upload_url is missing"
          }

          foreach ($assetPath in $assetsToUpload) {
            $assetName = Split-Path -Path $assetPath -Leaf
            $existing = $existingAssets | Where-Object { $_.name -eq $assetName } | Select-Object -First 1
            if ($existing) {
              Invoke-RestMethod `
                -Method Delete `
                -Uri "$apiBase/releases/assets/$($existing.id)" `
                -Headers $headers | Out-Null
            }

            $encodedName = [System.Uri]::EscapeDataString($assetName)
            $uploadUri = "$uploadUrlBase?name=$encodedName"
            Invoke-RestMethod `
              -Method Post `
              -Uri $uploadUri `
              -Headers $headers `
              -InFile $assetPath `
              -ContentType "application/octet-stream" | Out-Null
          }
